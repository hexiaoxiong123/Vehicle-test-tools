#!/bin/bash
#==========================================================================
# 车载系统健康监控脚本
#==========================================================================
# 功能：实时监控车载系统运行状态
# 作者：何枭雄
# 日期：2022-10-15
# 用途：路测前系统检查，确保GPS、网络、系统资源正常
#==========================================================================

# set -x
declare -i runtime
runtime=0

#==========================================================================
# GPS定位状态检测
#==========================================================================
function item_GPS()
{
    	gpsstate=`netcat 192.168.10.14 4001 |grep GNGGA|head -n 1 | awk -F ',' '{print $7}' &`
    	gps_num=`netcat 192.168.10.14 4001 |grep GNGGA|head -n 1 | awk -F ',' '{print $8}' &`
       echo "-----------------GPS收星数：$gps_num--------------------------------------------------------"
	if [[ $gpsstate -eq 1 ]]
		then
			echo "$now 当前GPS使用差分定位 - 正常" 
		else
			echo -e "\033[31m"$now [错误] 当前GPS状态异常" \033[0m"		 
		fi
		if [[ $gps_num -ge 20 ]]
		then
		echo "$now 当前GPS收星数量为$gps_num - 正常"
		else
		echo -e "\033[31m"$now [警告] 当前GPS收星数量为$gps_num（建议≥20颗）" \033[0m"	
		fi
}

#==========================================================================
# NTP时间同步检测
#==========================================================================
function item_ntp()
{
   ntp=`ntpdate -b 192.168.10.8`
   ARR=($ntp)
   BRR=${ARR[9]}
   # 检查时间偏移是否在允许范围内（±0.005秒）
   if [[ $(echo "$BRR < 0.005"| bc) -eq 1 ]]&&[[ $(echo "$BRR > -0.005"| bc) -eq 1 ]]
   then
   echo "$now NTP时间同步正常 (偏移: $BRR 秒)"
   else
   echo -e "\033[31m"$now [错误] NTP时间同步异常 (偏移: $BRR 秒)" \033[0m"
   fi
}

#==========================================================================
# CPU使用率检测
#==========================================================================
function item_cpu()
{
    	cpu_idle=`top -b -n 1 | grep Cpu | awk '{print $8}'|cut -f 1 -d "."`
    	cpu_use=`expr 100 - $cpu_idle`
       	echo "$now CPU使用率: $cpu_use% (空闲: $cpu_idle%)" 
}

#==========================================================================
# 内存使用检测
#==========================================================================
function item_mem()
{
    	mem_free=`free -m | grep "Mem" | awk '{print $4 + $6}'`
    	echo "$now 内存剩余空间: $mem_free MB"
}

#==========================================================================
# 磁盘使用率检测
#==========================================================================
function item_disk()
{
    	disk_use=`df -P | grep /dev  | grep -v -E '(tmp|boot)' | awk '{print $5}' | cut -f 1 -d "%"`
	echo "$now 磁盘使用率: $disk_use%"
}

#==========================================================================
# WIFI驱动检测
#==========================================================================
function item_net()
{
	net1=`ifconfig -a |grep -w "wlan0"`
        net2=`ifconfig -a |grep -w "wlp3s0"`
	if [[ "$net1" == "" ]] && [[ "$net2" == "" ]]
	then
		echo -e "\033[31m"$now [错误] WIFI驱动不存在" \033[0m"
	else
		echo "$now WIFI驱动存在 - 正常"	
	fi		
}

#==========================================================================
# 4G网络连接检测
#==========================================================================
function item_4g()
{
	line=`ping -c 3 180.76.103.37 |grep "3 received"| wc -l`
	if [[ "$line" == "1" ]]	
	then
		echo "$now 4G网络连接正常"
	else
		echo -e "\033[31m"$now [错误] 4G网络连接异常" \033[0m"
	fi	
}

#==========================================================================
# USB设备检测
#==========================================================================
function item_usb()
{
        line=`lsusb |grep "Western Digital"| wc -l`
        if [[ "$line" == "1" ]]
        then
                echo "$now USB存储设备已连接 - 正常"
        else
                echo -e "\033[31m"$now [警告] USB存储设备未连接" \033[0m"
        fi
}

#==========================================================================
# 主循环 - 每10秒执行一次检测
#==========================================================================
echo "=========================================="
echo "车载系统健康监控工具 v1.0"
echo "=========================================="
echo "监控项目："
echo "  - GPS定位状态和收星数量"
echo "  - CPU和内存使用率"
echo "  - 磁盘空间"
echo "  - 4G网络连接"
echo "  - NTP时间同步"
echo "=========================================="
echo "开始监控...（Ctrl+C 停止）"
echo ""

while [[ 1 ]]
do
    now=`date '+%Y-%m-%d %H:%M:%S'`
    echo "---------- $now ----------"
    item_cpu
    item_mem
    item_4g
    item_GPS
    # item_usb
    item_disk    
    item_ntp
    echo ""
    sleep 10
done

